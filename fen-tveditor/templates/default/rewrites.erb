    RewriteEngine on
    #RewriteLogLevel 1
    #RewriteLog "|/usr/bin/rotatelogs -l <%= node['apache']['log_dir'] %>/teachervision.rewrites.%Y%m%d 86400"
    RewriteOptions inherit

    RewriteCond %{HTTPS} on
    RewriteRule .? - [E=SCHEME:https]

    RewriteCond %{HTTPS} !on
    RewriteRule .? - [E=SCHEME:http]

    # These two lines will redirect all pages to a site-down message
    #  RewriteCond %{REQUEST_URI} !^/(css|js)
    #  RewriteRule .* /site/html/tv/tv-down.htm [L]

    RewriteCond %{HTTP_HOST} ^(dev|redesign|stage)[-.]
    RewriteRule . - [E=IMAGE_HOST:%{HTTP_HOST}]

    RewriteCond %{HTTP_HOST} ^stage[.]
    RewriteRule . - [E=TEMPLATE_DIR:stage/www.teachervision.com]

    RewriteCond %{HTTP_HOST} ^redesign[.]
    RewriteRule . - [E=TEMPLATE_DIR:redesign.teachervision.com]
    
    RewriteRule ^/(css|images|img|js|video)/(.*) %{ENV:SCHEME}://<%= node['fen']['sitevars']['global']['IMAGE_HOST'] %>/$1/$2 [R=301,L]

    # To avoid getting flagged for duplicate content, external /lesson-plans URLs
    # should now be redirected to /page (which will be rewritten internally
    # back to /lesson-plans/...)
    RewriteRule ^/lesson-plans/lesson-(\d+.html) %{ENV:SCHEME}://%{HTTP_HOST}/page/$1 [R=permanent,L]

    # Correct for weird transformations in emails
    RewriteRule "^/botr/([a-z0-9]*)_ ([a-z0-9]*).html" /botr/$1_$2.html
    # This one corrects for a ? => %3F conversion
    RewriteRule ^/botr/(.*)\?(.*) /botr/$1?$2

    # google webmaster files needs to be in the docroot
    RewriteRule ^/google176b05c160c64c56.html$ - [R=200,L]
    RewriteRule ^/google32115ef79866f150.html$ - [R=200,L]
    RewriteRule ^/googlee4ee029fb4377552.html$ - [R=200,L]

    # the "go" redirector ahs been shut down as insecure
    RewriteRule ^/go/ - [R=410,L]

    RewriteRule ^/(movies)(.html)?$ http://%{HTTP_HOST}/$1/ [R=301,L]
    RewriteRule ^/(movies)/(index.html)$ http://%{HTTP_HOST}/$1/ [R=301,L]
    RewriteRule ^/(movies)/$ /applets/$1.php [L]
    RewriteRule ^/(movies)/(.*)/([0-9]{2,7})$ /applets/$1.php?id=$3 [L]
    RewriteRule ^/(movies)/([0-9]{2,7})$ /applets/$1.php?id=$2 [L]
    RewriteRule ^/(movies)/([^/]+)$ /applets/$1.php?fl=$2 [L]

    RewriteCond  %{HTTP_HOST}  familyeducation.com
    RewriteCond  %{HTTP_HOST}  !school.familyeducation.com
    RewriteRule ^(/edu/colleges/.*) / [R=301,L]

    RewriteRule ^/edu/colleges/([A-Za-z][A-Za-z])(/|\.html)?$ / [R=301,L]
    RewriteRule ^/edu/colleges/([0-9]+)(/|\.html)?$ / [R=301,L]
    RewriteRule ^/edu/colleges/([0-9]+)/([a-zA-Z]+)\.html / [R=301,L]

    # Handle premium PDFs - all PDF requests must go through this script now
    RewriteRule ^(/tv/printables/.*\.pdf)$ /tv/applets/print-pay.php?page=$1&%{QUERY_STRING}
    RewriteRule ^(/tv/printables/.*\.ppt)$ /tv/applets/print-img.php?page=$1&%{QUERY_STRING}
    RewriteRule ^(/tv/resources/PDF/.*\.pdf)$ /tv/applets/print-pay.php?page=$1&%{QUERY_STRING}

    # TV/HS/FE store handling
    RewriteRule ^/store/(sku|isbn)/([0-9][0-9X]*)/(info|buy|cover|cover_s).(html|gif|jpg)$ /tv/store.php?code=$1&sku=$2&type=$3&%{QUERY_STRING}

    RewriteRule ^/tv/(card-updated|free-trial|login|logout|membership|purchase-complete|purchase-failed|subscription-receipt)[.](html|php)$ %{ENV:SCHEME}://%{HTTP_HOST}/$1 [L,R=301]
    RewriteRule ^/(card-updated|free-trial|login|logout|membership|purchase-complete|purchase-failed|subscription-receipt)[.](html|php)$ %{ENV:SCHEME}://%{HTTP_HOST}/$1 [L,R=301]

    RewriteRule ^/(login|logout|membership|subscription-receipt)$ /site/html/tv/$1.php [L,QSA]
    RewriteRule ^/(card-updated|free-trial|free-trial-confirmation|renew-confirmation|purchase-complete|purchase-failed)$ /site/html/tv/$1.html [L,QSA]
    RewriteRule ^/(renew)$ /site/html/tv/free-trial.html?billingPlan=renewal [L,QSA]

    # This one is because we get a lot of 404s on /lesson-plans/
    RedirectMatch ^/lesson-plans/*$ /tv/curriculum/lessonplans/index.html

    # This is to handle a typo in 8/19/2002 Press Release
    RedirectMatch ^/lesson-plans/lessons-(.*) /lesson-plans/lesson-$1

    # Weekly Web Adventures and Ask the Specialist are gone.
    RedirectMatch permanent ^/tv/curriculum/weeklywebadventures.* /
    RedirectMatch permanent ^/tv/resources/specialist.*           /

    # This page has been superseded by the Subjects tab (SR 1270)
    RedirectMatch permanent ^/.*/5774.html /tv/subjects.php

    # This rewrite handles Homework Relief Center (added 1/31/2003)
    RedirectPermanent /lesson-plans/lesson-5838.html http://www.homeworkreliefcenter.com/

    # This rewrite rule handles e-cards, making them look like they live someplace else
    RewriteRule ^/e-cards/([^/]+)/([^/]+).html$        /lesson-plans/inactive/lesson-$2.html?%{QUERY_STRING}&k=$1

    # This rewrite rule is to allow each email-page to make a log entry
    # like /emailed/tv/features/index.html
    RewriteRule ^/emailed/(.*)$ /tv/email-page/dummy.html
    # This rewrite rule is for logging searches with number of results
    RewriteRule ^/searched/(.*)$ /tv/email-page/dummy.html

    # These rewrite rules allows us to phase out /lesson-plans/lesson-#.html in favor
    # of the more generic - and therefore less misleading - /page/#.html.
    RewriteRule ^/page/([0-9]+\.p?html.*)$ /lesson-plans/lesson-$1

    # .phtml to .html project
    RewriteRule ^/page/inactive/([0-9]+).html /lesson-plans/inactive/lesson-$1.html

    # Friendly URLs are handled by notfound.php, but try to short-circuit that path
    # in most cases by rewriting conditionally if the file exists.

    RewriteCond %{REQUEST_URI} !^/tv/
    RewriteCond /site/html/lesson-plans/lesson-$1.html -f
    RewriteRule ^/(?:[-a-zA-Z0-9._,]+/)+([1-9][0-9]*)\.html$ /site/html/lesson-plans/lesson-$1.html [L]

    # The following rules handle ads and promotions for TeacherVision.
    # on other sites.  Some of the TeacherVision ads link to internal places
    # on the old site; this allows them to continue to work.
    # Home page from StoryServer-based site
    RewriteRule ^/tv_index/*$  /tv/ [PT]
    # Lesson plans channel
    RewriteRule /lessonplans/0,2606,,00\.(.+)  /tv/curriculum/lessonplans/index.html [PT]
    # Newsletter signup page
    RewriteRule ^/resources/list/0,2608,58,00\.(.+) /tv/lounge/newsletter/index.html [PT]
    # Seminar signup (Carolyn Adorney)
    RewriteRule ^/seminars?/?$ /lesson-plans/lesson-5778.html
    # April 17, 2001 Great Stuff had bad URL
    RedirectMatch permanent ^/lesson-plans/lesson-5855(\?egs041702)?$ /lesson-plans/lesson-5855.html?egs041702
    # July 25, 2001 requested by Kathy
    RewriteRule ^/leaderkits/?(\?.*)? /lesson-plans/lesson-5778.html$1
    # Aug 2, 2001 requested by Paul Chapman
    RewriteRule ^/polaroid/?(\?.*)? /lesson-plans/lesson-6540.html$1
    # Aug 27, 2001 requested by Paul Chapman
    RewriteRule ^/sf/?(\?.*)? /tv/scottforesman/index.html$1
    # Sep 13, 2001 requested by Kathy
    RewriteRule ^/[Ss]ept11/?(\?.*)? /lesson-plans/lesson-6807.html$1
    # Oct 30, 2001 requested by Kathy
    RewriteRule ^/[Nn][Ss][Tt][Aa]/?$ /tv/lounge/newsletter/science/index.html
    
    # Jan 7 2002: Work around invalid IMG SRC in
    # http://www.boxermath.com/learningnetwork/teachervision/boxer_tv_strip_102401.html
    # Use RedirectMatch instead of Redirect to avoid giving a hostname
    RedirectMatch 301 ^/spacer.gif /images/tv/spacer.gif
    
    # "Intranet" rewrite (Carolyn Adorney) - for LN trainer use only,
    # but unrestricted access so they can use it from any Web browser
    RewriteRule ^/workshops/traininginfo/*$ /tv/development/trainingcenter/info_center.php
    
    # This rule allows index.html, etc. to live in the tv subdir.
    RewriteRule ^/([^/]*)\.html /tv/$1.html [PT]
    
    # Handle bookmark icon
    RewriteRule ^/favicon.ico$  /tv/favicon.ico [PT]
    
    # These rules allow us to disguise our active links so search engines will
    # feel safe in following them.
    RewriteRule ^/tv/lpsearch/(.*)   /tv/lpsearch.php?$1 [PT]
    RewriteRule ^/tv/tvsearch/(.*)   /tv/tvsearch.php?$1 [PT]
    RewriteRule ^/tv/theme/(.*)      /tv/theme.php?theme=$1 [PT]
    RewriteRule ^/tv/subjects/(.*)   /tv/grades_subjects.php?term=$1 [PT]
    RewriteRule ^/tv/grades/([0-9]+)/([0-9]+)  /tv/grades_subjects.php?lowest_grade=$1&highest_grade=$2 [PT]
    RewriteRule ^/offsite/(.*)/  /tv/leavingfen.php?urlid=$1 [PT]
    RewriteRule ^/offsite/(.*)  /tv/leavingfen.php?urlid=$1 [PT]

    # sitemap
    RewriteRule ^/sitemap/ /tv/sitemap.html [PT]

    # Newsletter signup page redirects (SR 1222 11/09/2006)
    RedirectMatch 301 ^/tv/lounge/newsletter/(science|new-teacher|music|exceptional)-signup\.p?html http://newsletters.teachervision.com

    # Individual state ed dept. pages have been replaced by one combined page
    RewriteRule /6428\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
    RewriteRule /6430\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
    RewriteRule /6431\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
    RewriteRule /6432\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
    RewriteRule /6433\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
    RewriteRule /6434\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
    RewriteRule /6435\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
    RewriteRule /6436\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
    RewriteRule /6437\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
    RewriteRule /6438\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
    RewriteRule /6439\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
    RewriteRule /6440\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
    RewriteRule /6441\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
    RewriteRule /6443\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
    RewriteRule /6444\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
    RewriteRule /6445\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
    RewriteRule /6446\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
    RewriteRule /6447\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
    RewriteRule /6448\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
    RewriteRule /6449\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
    RewriteRule /6450\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
    RewriteRule /6451\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
    RewriteRule /6452\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
    RewriteRule /6453\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
    RewriteRule /6454\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
    RewriteRule /6455\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
    RewriteRule /6456\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
    RewriteRule /6457\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
    RewriteRule /6458\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
    RewriteRule /6459\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
    RewriteRule /6460\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
    RewriteRule /6462\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
    RewriteRule /6463\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
    RewriteRule /6465\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
    RewriteRule /6466\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
    RewriteRule /6468\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
    RewriteRule /6469\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
    RewriteRule /6470\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
    RewriteRule /6471\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
    RewriteRule /6472\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
    RewriteRule /6473\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
    RewriteRule /6474\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
    RewriteRule /6475\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
    RewriteRule /6476\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
    RewriteRule /6477\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
    RewriteRule /6478\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
    RewriteRule /6487\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
    RewriteRule /6488\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
    RewriteRule /6489\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
    RewriteRule /6490\.html /educational-associations/education-and-state/6387.html [R=permanent,L]

    # More redirects for newsletter
    # Great Stuff Vol. 2
    Redirect /resources/list/0,2608,20,00.html https://www.teachervision.com/tv/lounge/newsletter/index.html
    # Great Stuff Vol. 1
    Redirect /resources/list/0,2608,16,00.html https://www.teachervision.com/tv/lounge/newsletter/index.html
    # Literature Lessons
    Redirect /resources/list/1,2608,42,00.html https://www.teachervision.com/tv/lounge/newsletter/index.html
    # School Safety promotion
    RewriteRule ^/safety/*$ /lesson-plans/lesson-6661.html

    # Redirect to work around invalid FunBrain URL (on the flash cards) to our site.
    Redirect /lessonplans/plan/0,2607,14,00.html https://www.teachervision.com/lesson-plans/lesson-5779.html

    # Here are some URLs from the StoryServer-based site that we'd like to keep working
    # Home page in all its guises.  The RewriteRule for tv_index should really go away so that bookmarks
    # won't refer to the old URL.
    Redirect /tv_index/0,2604,,00.html  https://www.teachervision.com/
    Redirect /tv_index/ https://www.teachervision.com/
    Redirect /tv_index  https://www.teachervision.com/
    # Some sites link to our logo directly.  It's free advertising, so keep it working.
    Redirect /img/tv/tvlogo.gif https://www.teachervision.com/images/teachervision_logo80.gif
    Redirect /img/tv/TVlogo.gif https://www.teachervision.com/images/teachervision_logo80.gif
    # This one kept coming up in search engine searches for "dictionary", "encyclopedia", or "almanac"
    Redirect /reference/list/1,2613,17,00.html https://www.teachervision.com/tv/curriculum/researchcenter/index.html
    # This one kept coming up in search engine searches for "education" and "teacher resources"
    Redirect /resources/0,2605,,00.html https://www.teachervision.com/
    # This one kept coming up in search engine searches for "downloads"
    Redirect /resources/list/0,2608,15,00.html https://www.teachervision.com/tv/resources/technology/index.html

    # Here are some URLs from the Aug 8 site we'd like to keep working
    Redirect /tv/resources/tactics/sped/index.html  https://www.teachervision.com/tv/resources/tactics/specialneeds.html
    Redirect /tv/curriculum/reference.html    https://www.teachervision.com/tv/curriculum/researchcenter/index.html

    # Avoid duplicate content (SR 1411)
    RewriteRule ^/rubrics/teaching-methods/635[6789].html https://%{HTTP_HOST}/rubrics/assessment/26773.html [R=301,L]

    # Where IP licenses content, we must be careful it does not show up outside infoplease.com
    RewriteCond %{HTTP_HOST} !\.infoplease\.com$
    RewriteCond %{REQUEST_URI} !^/[-A-Za-z0-9.]+/[0-9]+.html$
    RewriteCond %{REQUEST_URI} !^/[-A-Za-z0-9.]+/[-A-Za-z0-9.]+/[0-9]+.html$
    RewriteRule ^/(atlas|biography|ipd|ipsa|ce6|bio|country|daily|dictionary|encyclopedia|ipa|ipd|ipea|ipka|ipkd|ipsa|kids|main|news|rhc|spot|t|thesaurus|timelines|toptens|trivia|word|xwords|year)/(.*) http://www.infoplease.com/$1/$2 [R=301,L]

    # We are moving 301s to 410s
    RewriteCond %{HTTP_HOST} !\.infoplease\.com$
    RewriteCond %{REQUEST_URI} !^/[-A-Za-z0-9.]+/[0-9]+.html$
    RewriteCond %{REQUEST_URI} !^/[-A-Za-z0-9.]+/[-A-Za-z0-9.]+/[0-9]+.html$
    RewriteRule ^/(askeds|astrology|finance|ihealth|press|rss)/(.*) http://www.infoplease.com/$1/$2 [R=410,L]

    # We are moving 301s to 410s
    RewriteCond %{HTTP_HOST} !\.infoplease\.com$
    RewriteCond %{REQUEST_URI} !^/[-A-Za-z0-9.]+/[0-9]+.html$
    RewriteCond %{REQUEST_URI} !^/[-A-Za-z0-9.]+/[-A-Za-z0-9.]+/[0-9]+.html$
    RewriteRule ^/(askeds|astrology|finance|ihealth|press|rss)/(.*) http://www.infoplease.com/$1/$2 [R=410,L]

    AliasMatch  ^/([^/]*)\.php3$ /site/html/applets/$1.php3
    AliasMatch  ^/([^/]*)\.php$  /site/html/applets/$1.php

    RewriteRule /robots.txt /site/html/applets/robots.php [L]
    
    RewriteMap flowplayer txt:/site/data/flowplayer.dat
    RewriteCond %{REQUEST_URI} ^/video/
    RewriteCond %{REQUEST_URI} ^/video.*/([^/]+)/([^/]+)\.flv$
    RewriteCond ${flowplayer:%1|nomatch} valid
    RewriteRule ^/video(.*/)([^/]+)/([^/]+)\.flv$ /site/images/video/$1$3.flv [L]

    RewriteRule ^/images/video/.*\.flv - [R=404,L]

    RewriteRule ^(.*)\.[0-9]{10}\.(css|js|gif|png|jpe?g)$ $1.$2
  
    RewriteRule ^(/dyn/.*)$ /site/images/$1 [L]
    RewriteRule ^/img/(.*)$ /images/fe/$1 [L]
    RewriteRule ^/mov/(.*)$ /site/images/mov/$1 [L]

    RewriteRule ^/ln/[^/.]+/images/shim.gif$ /images/spacer.gif [L]
