<VirtualHost *:80>
  ServerName <%= @params[:server_name] %>
  <% if @params[:server_aliases] -%>
  ServerAlias <%= @params[:server_aliases].join " " %>
  <% end -%>

  CookieTracking on

  LogFormat "%h %{local}p %u %t \"%r\" %>s %B \"%{Referer}i\" \"%{User-Agent}i\" %{Host}i %v %D %{Apache}C \"%{Accept-Language}i\" \"%{X-Forwarded-For}i\" %{X-Amz-Cf-Id}i" combined
  CustomLog "|/usr/bin/rotatelogs -l <%= node['apache']['log_dir'] %>/teachervision.com.%Y%m%d 86400" common
  #ErrorLog "|/usr/bin/rotatelogs -l <%= node['apache']['log_dir'] %>/teachervision.com.errors.%Y%m%d"

  <LocationMatch "^/(css|images|js)/">
      php_flag engine off
  </LocationMatch>

  AddType application/x-httpd-php .php .php3 .xhtml .phtml .html .rss
  php_value auto_prepend_file "/site/cfg/prepend-tv.php"
  php_value default_charset "utf-8"

  DocumentRoot <%= @params[:docroot] %>
  <Directory <%= @params[:docroot] %>>
    Allow from All
    # This allows tv to be a symlink
    Options FollowSymLinks
  </Directory>

  ErrorDocument 404 /tv/notfound.php
  ErrorDocument 403 /tv/notfound.php

  DirectoryIndex index.php index.php3 index.xhtml index.html index.phtml index.htm

  RewriteEngine on
  RewriteOptions inherit

  RewriteCond %{HTTPS} on
  RewriteRule .? - [E=SCHEME:https]

  RewriteCond %{HTTPS} !on
  RewriteRule .? - [E=SCHEME:http]

  # To avoid getting flagged for duplicate content, external /lesson-plans URLs
  # should now be redirected to /page (which will be rewritten internally
  # back to /lesson-plans/...)
  RewriteRule ^/lesson-plans/lesson-(\d+.html) %{ENV:SCHEME}://%{HTTP_HOST}/page/$1 [R=permanent,L]

  # Correct for weird transformations in emails
  RewriteRule "^/botr/([a-z0-9]*)_ ([a-z0-9]*).html" /botr/$1_$2.html
  # This one corrects for a ? => %3F conversion
  RewriteRule ^/botr/(.*)\?(.*) /botr/$1?$2

  # google webmaster files needs to be in the docroot
  RewriteRule ^/google176b05c160c64c56.html$ - [R=200,L]
  RewriteRule ^/google32115ef79866f150.html$ - [R=200,L]
  RewriteRule ^/googlee4ee029fb4377552.html$ - [R=200,L]

  # the "go" redirector ahs been shut down as insecure
  RewriteRule ^/go/ - [R=410,L]

  # [4] >>>>>>>> ../../global/movies.conf
  RewriteRule ^/(movies)(.html)?$ http://%{HTTP_HOST}/$1/ [R=301,L]
  RewriteRule ^/(movies)/(index.html)$ http://%{HTTP_HOST}/$1/ [R=301,L]
  RewriteRule ^/(movies)/$ /applets/$1.php [L]
  RewriteRule ^/(movies)/(.*)/([0-9]{2,7})$ /applets/$1.php?id=$3 [L]
  RewriteRule ^/(movies)/([0-9]{2,7})$ /applets/$1.php?id=$2 [L]
  RewriteRule ^/(movies)/([^/]+)$ /applets/$1.php?fl=$2 [L]

  RewriteCond  %{HTTP_HOST}  familyeducation.com
  RewriteCond  %{HTTP_HOST}  !school.familyeducation.com
  RewriteRule ^(/edu/colleges/.*) / [R=301,L]

  RewriteRule ^/edu/colleges/([A-Za-z][A-Za-z])(/|\.html)?$ / [R=301,L]
  RewriteRule ^/edu/colleges/([0-9]+)(/|\.html)?$ / [R=301,L]
  RewriteRule ^/edu/colleges/([0-9]+)/([a-zA-Z]+)\.html / [R=301,L]
  # [4] <<<<<<<< ../../global/movies.conf


  # Handle premium PDFs - all PDF requests must go through this script now
  RewriteRule ^(/tv/printables/.*\.pdf)$ /tv/applets/print-pay.php?page=$1&%{QUERY_STRING}
  RewriteRule ^(/tv/printables/.*\.ppt)$ /tv/applets/print-img.php?page=$1&%{QUERY_STRING}
  RewriteRule ^(/tv/resources/PDF/.*\.pdf)$ /tv/applets/print-pay.php?page=$1&%{QUERY_STRING}


# [4] >>>>>>>> ../../global/store.conf
  # TV/HS/FE store handling
  RewriteRule ^/store/(sku|isbn)/([0-9][0-9X]*)/(info|buy|cover|cover_s).(html|gif|jpg)$ /tv/store.php?code=$1&sku=$2&type=$3&%{QUERY_STRING}
# [4] <<<<<<<< ../../global/store.conf


  RewriteRule ^/tv/(card-updated|free-trial|login|logout|membership|purchase-complete|purchase-failed|subscription-receipt)[.](html|php)$ %{ENV:SCHEME}://%{HTTP_HOST}/$1 [L,R=301]
  RewriteRule ^/(card-updated|free-trial|login|logout|membership|purchase-complete|purchase-failed|subscription-receipt)[.](html|php)$ %{ENV:SCHEME}://%{HTTP_HOST}/$1 [L,R=301]

  RewriteRule ^/(login|logout|membership|subscription-receipt)$ /site/html/tv/$1.php [L,QSA]
  RewriteRule ^/(card-updated|free-trial|free-trial-confirmation|renew-confirmation|purchase-complete|purchase-failed)$ /site/html/tv/$1.html [L,QSA]
  RewriteRule ^/(renew)$ /site/html/tv/free-trial.html?billingPlan=renewal [L,QSA]

  # This one is because we get a lot of 404s on /lesson-plans/
  RedirectMatch ^/lesson-plans/*$ /tv/curriculum/lessonplans/index.html

  # This is to handle a typo in 8/19/2002 Press Release
  RedirectMatch ^/lesson-plans/lessons-(.*) /lesson-plans/lesson-$1

  # Weekly Web Adventures and Ask the Specialist are gone.
  RedirectMatch permanent ^/tv/curriculum/weeklywebadventures.* /
  RedirectMatch permanent ^/tv/resources/specialist.*           /

  # This page has been superseded by the Subjects tab (SR 1270)
  RedirectMatch permanent ^/.*/5774.html /tv/subjects.php

  # This rewrite handles Homework Relief Center (added 1/31/2003)
  RedirectPermanent /lesson-plans/lesson-5838.html http://www.homeworkreliefcenter.com/

  # This rewrite rule handles e-cards, making them look like they live someplace else
  RewriteRule ^/e-cards/([^/]+)/([^/]+).html$        /lesson-plans/inactive/lesson-$2.html?%{QUERY_STRING}&k=$1

# This rewrite rule is to allow each email-page to make a log entry
# like /emailed/tv/features/index.html
  RewriteRule ^/emailed/(.*)$ /tv/email-page/dummy.html
# This rewrite rule is for logging searches with number of results
  RewriteRule ^/searched/(.*)$ /tv/email-page/dummy.html

# These rewrite rules allows us to phase out /lesson-plans/lesson-#.html in favor
# of the more generic - and therefore less misleading - /page/#.html.
  RewriteRule ^/page/([0-9]+\.p?html.*)$ /lesson-plans/lesson-$1

  # .phtml to .html project
  RewriteRule ^/page/inactive/([0-9]+).html /lesson-plans/inactive/lesson-$1.html

# Friendly URLs are handled by notfound.php, but try to short-circuit that path
# in most cases by rewriting conditionally if the file exists.

  RewriteCond %{REQUEST_URI} !^/tv/
  RewriteCond /site/html/lesson-plans/lesson-$1.html -f
  RewriteRule ^/(?:[-a-zA-Z0-9._,]+/)+([1-9][0-9]*)\.html$ /site/html/lesson-plans/lesson-$1.html [L]

# The following rules handle ads and promotions for TeacherVision.
# on other sites.  Some of the TeacherVision ads link to internal places
# on the old site; this allows them to continue to work.
  # Home page from StoryServer-based site
  RewriteRule ^/tv_index/*$  /tv/ [PT]
  # Lesson plans channel
  RewriteRule /lessonplans/0,2606,,00\.(.+)  /tv/curriculum/lessonplans/index.html [PT]
  # Newsletter signup page
  RewriteRule ^/resources/list/0,2608,58,00\.(.+) /tv/lounge/newsletter/index.html [PT]
  # Seminar signup (Carolyn Adorney)
  RewriteRule ^/seminars?/?$ /lesson-plans/lesson-5778.html
  # April 17, 2001 Great Stuff had bad URL
  RedirectMatch permanent ^/lesson-plans/lesson-5855(\?egs041702)?$ /lesson-plans/lesson-5855.html?egs041702
  # July 25, 2001 requested by Kathy
  RewriteRule ^/leaderkits/?(\?.*)? /lesson-plans/lesson-5778.html$1
  # Aug 2, 2001 requested by Paul Chapman
  RewriteRule ^/polaroid/?(\?.*)? /lesson-plans/lesson-6540.html$1
  # Aug 27, 2001 requested by Paul Chapman
  RewriteRule ^/sf/?(\?.*)? /tv/scottforesman/index.html$1
  # Sep 13, 2001 requested by Kathy
  RewriteRule ^/[Ss]ept11/?(\?.*)? /lesson-plans/lesson-6807.html$1
  # Oct 30, 2001 requested by Kathy
  RewriteRule ^/[Nn][Ss][Tt][Aa]/?$ /tv/lounge/newsletter/science/index.html

# Jan 7 2002: Work around invalid IMG SRC in
# http://www.boxermath.com/learningnetwork/teachervision/boxer_tv_strip_102401.html
# Use RedirectMatch instead of Redirect to avoid giving a hostname
  RedirectMatch 301 ^/spacer.gif /images/tv/spacer.gif

# "Intranet" rewrite (Carolyn Adorney) - for LN trainer use only,
# but unrestricted access so they can use it from any Web browser
  RewriteRule ^/workshops/traininginfo/*$ /tv/development/trainingcenter/info_center.php

# This rule allows index.html, etc. to live in the tv subdir.
  RewriteRule ^/([^/]*)\.html /tv/$1.html [PT]

# Handle bookmark icon
  RewriteRule ^/favicon.ico$  /tv/favicon.ico [PT]

# These rules allow us to disguise our active links so search engines will
# feel safe in following them.
  RewriteRule ^/tv/lpsearch/(.*)   /tv/lpsearch.php?$1 [PT]
  RewriteRule ^/tv/tvsearch/(.*)   /tv/tvsearch.php?$1 [PT]
  RewriteRule ^/tv/theme/(.*)      /tv/theme.php?theme=$1 [PT]
  RewriteRule ^/tv/subjects/(.*)   /tv/grades_subjects.php?term=$1 [PT]
  RewriteRule ^/tv/grades/([0-9]+)/([0-9]+)  /tv/grades_subjects.php?lowest_grade=$1&highest_grade=$2 [PT]
  RewriteRule ^/offsite/(.*)/  /tv/leavingfen.php?urlid=$1 [PT]
  RewriteRule ^/offsite/(.*)  /tv/leavingfen.php?urlid=$1 [PT]

# sitemap
  RewriteRule ^/sitemap/ /tv/sitemap.html [PT]

# Newsletter signup page redirects (SR 1222 11/09/2006)
  RedirectMatch 301 ^/tv/lounge/newsletter/(science|new-teacher|music|exceptional)-signup\.p?html http://newsletters.fen.com/email/login/?nl_t


# [4] >>>>>>>> ../../global/tv-states.conf
  # Individual state ed dept. pages have been replaced by one combined page
  RewriteRule /6428\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
  RewriteRule /6430\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
  RewriteRule /6431\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
  RewriteRule /6432\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
  RewriteRule /6433\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
  RewriteRule /6434\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
  RewriteRule /6435\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
  RewriteRule /6436\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
  RewriteRule /6437\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
  RewriteRule /6438\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
  RewriteRule /6439\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
  RewriteRule /6440\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
  RewriteRule /6441\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
  RewriteRule /6443\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
  RewriteRule /6444\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
  RewriteRule /6445\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
  RewriteRule /6446\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
  RewriteRule /6447\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
  RewriteRule /6448\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
  RewriteRule /6449\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
  RewriteRule /6450\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
  RewriteRule /6451\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
  RewriteRule /6452\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
  RewriteRule /6453\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
  RewriteRule /6454\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
  RewriteRule /6455\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
  RewriteRule /6456\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
  RewriteRule /6457\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
  RewriteRule /6458\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
  RewriteRule /6459\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
  RewriteRule /6460\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
  RewriteRule /6462\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
  RewriteRule /6463\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
  RewriteRule /6465\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
  RewriteRule /6466\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
  RewriteRule /6468\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
  RewriteRule /6469\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
  RewriteRule /6470\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
  RewriteRule /6471\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
  RewriteRule /6472\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
  RewriteRule /6473\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
  RewriteRule /6474\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
  RewriteRule /6475\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
  RewriteRule /6476\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
  RewriteRule /6477\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
  RewriteRule /6478\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
  RewriteRule /6487\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
  RewriteRule /6488\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
  RewriteRule /6489\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
  RewriteRule /6490\.html /educational-associations/education-and-state/6387.html [R=permanent,L]
# [4] <<<<<<<< ../../global/tv-states.conf


# removed all redirects as it is too old ( Jan 7, 2011)

##**************  remove these comments after few weeks
# Redirects for ad tracking
  # On email-13 and email-14, I'm not sure which version (.html or bare) is correct,
  # so I'm putting in both for now.
  # Note that a simple URL of the form /foo.html has already been rewritten to
  # /tv/foo.html by the time the Redirect code sees it.

# Next ones requested Jan 3 2001
# This one requested Jan 4 2001
# These requested Jan 16 2001, inserted Jan 18
#### These requested 2/28/2001 for insertion by 3/1/2001.  Lots of notice on this one!
#### I tried to change the "?mc=%m" since it's invalid URL syntax,
#### but Veerle De Lombaerde at Hook Media said it didn't work.
  # SurfNetKids week 1
  # SurfNetKids week 2
  # SurfNetKids week 2 - error?
  # SurfNetKids week 3
  # SurfNetKids week 4
  # MathGoodies March insertion
##************* end

# More redirects for newsletter
  # Great Stuff Vol. 2
  Redirect /resources/list/0,2608,20,00.html https://www.teachervision.com/tv/lounge/newsletter/index.html
  # Great Stuff Vol. 1
  Redirect /resources/list/0,2608,16,00.html https://www.teachervision.com/tv/lounge/newsletter/index.html
  # Literature Lessons
  Redirect /resources/list/1,2608,42,00.html https://www.teachervision.com/tv/lounge/newsletter/index.html
# School Safety promotion
  RewriteRule ^/safety/*$ /lesson-plans/lesson-6661.html

# Redirect to work around invalid FunBrain URL (on the flash cards) to our site.
  Redirect /lessonplans/plan/0,2607,14,00.html https://www.teachervision.com/lesson-plans/lesson-5779.html

# Here are some URLs from the StoryServer-based site that we'd like to keep working
  # Home page in all its guises.  The RewriteRule for tv_index should really go away so that bookmarks
  # won't refer to the old URL.
  Redirect /tv_index/0,2604,,00.html    https://www.teachervision.com/
  Redirect /tv_index/   https://www.teachervision.com/
  Redirect /tv_index    https://www.teachervision.com/
  # Some sites link to our logo directly.  It's free advertising, so keep it working.
  Redirect /img/tv/tvlogo.gif https://www.teachervision.com/images/teachervision_logo80.gif
  Redirect /img/tv/TVlogo.gif https://www.teachervision.com/images/teachervision_logo80.gif
  # This one kept coming up in search engine searches for "dictionary", "encyclopedia", or "almanac"
  Redirect /reference/list/1,2613,17,00.html https://www.teachervision.com/tv/curriculum/researchcenter/index.html
  # This one kept coming up in search engine searches for "education" and "teacher resources"
  Redirect /resources/0,2605,,00.html https://www.teachervision.com/
  # This one kept coming up in search engine searches for "downloads"
  Redirect /resources/list/0,2608,15,00.html https://www.teachervision.com/tv/resources/technology/index.html

# Here are some URLs from the Aug 8 site we'd like to keep working
  Redirect /tv/resources/tactics/sped/index.html  https://www.teachervision.com/tv/resources/tactics/specialneeds.html
  Redirect /tv/curriculum/reference.html      https://www.teachervision.com/tv/curriculum/researchcenter/index.html

  # Avoid duplicate content (SR 1411)
  RewriteRule ^/rubrics/teaching-methods/635[6789].html https://%{HTTP_HOST}/rubrics/assessment/26773.html [R=301,L]

  # Where IP licenses content, we must be careful it does not show up outside infoplease.com
  RewriteCond %{HTTP_HOST} !\.infoplease\.com$
  RewriteCond %{REQUEST_URI} !^/[-A-Za-z0-9.]+/[0-9]+.html$
  RewriteCond %{REQUEST_URI} !^/[-A-Za-z0-9.]+/[-A-Za-z0-9.]+/[0-9]+.html$
  RewriteRule ^/(atlas|biography|ipd|ipsa|ce6|askeds|astrology|bio|country|daily|dictionary|encyclopedia|finance|ihealth|ipa|ipd|ipea|ipka|ipkd|ipsa|kids|main|news|press|rhc|rss|spot|t|thesaurus|timelines|toptens|trivia|word|xwords|year)/(.*) http://www.infoplease.com/$1/$2 [R=301,L]

  AliasMatch  ^/([^/]*)\.php3$ /site/html/applets/$1.php3
  AliasMatch  ^/([^/]*)\.php$  /site/html/applets/$1.php

  RewriteRule /robots.txt /site/html/applets/robots.php [L]
  Alias /1x1.gif /site/html/applets/pixel.php

  # /tv/private contains the summary spreadsheets
  AliasMatch ^/tv/private/(.*) /site/cache/tv/summary/$1

  <Directory /site/cache/tv/summary>
    Options Indexes
    Order deny,allow
    Deny from all

    # Allow from the Global Ops VPC
    Allow from 10.0.0.0/16

    <%= render "global-partners.erb" %>
  </Directory>

  # /tv/forms/private contains admin support for contest forms, etc. plus the "baby page"
  <Location /tv/forms/private>
    Options Indexes
    Order deny,allow
    Deny from all

    # Allow from the Global Ops VPC
    Allow from 10.0.0.0/16

    <%= render "global-partners.erb" %>
  </Location>

  <%= render "rewrites.erb" %>

</VirtualHost>