<VirtualHost *:<%= @params[:server_port] || node['apache']['listen_ports'].first %>>
  ServerName <%= @params[:server_name] %>
  <% if @params[:server_aliases] -%>
  ServerAlias <%= @params[:server_aliases].join " " %>
  <% end -%>

  LogFormat "%h %{local}p %u %t \"%r\" %>s %B \"%{Referer}i\" \"%{User-Agent}i\" %{Host}i %v %D %{Apache}C \"%{Accept-Language}i\" \"%{X-Forwarded-For}i\" %{X-Amz-Cf-Id}i" combined
  CustomLog "|/usr/bin/rotatelogs -l /var/log/apache2/<%= @params[:server_name] %>.%Y%m%d 86400" common

  RewriteEngine on
  RewriteRule ^.*/favicon.ico$ /sites/familyeducation.com/files/familyeducation_favicon.ico [L]

  DocumentRoot <%= @params[:docroot] %>

  <Directory <%= @params[:docroot] %>>
    Options Indexes FollowSymLinks
    AllowOverride All
    Require all granted
  </Directory>
  
 <FilesMatch "(\.(engine|inc|install|module|sh|.*sql|theme|tpl(\.php)?|xtmpl)|code-style\.pl|Entries.*|Repository|Root)$">
    Order deny,allow
    Deny from all
  </FilesMatch>

  # Customized error messages.
  ErrorDocument 404 /index.php

  # Set the default handler.
  DirectoryIndex index.php

  RewriteEngine on

  RewriteCond %{HTTP_USER_agent} env=80legs [NC]
  RewriteRule ^(.*)$ - [F]

  # block user agents from site access
  RewriteCond %{HTTP_USER_AGENT} (www.80legs.com/webcrawler.html) [NC]
  RewriteRule ^(.*)$ - [F]

  RewriteCond %{ENV:LIVE} 0
  RewriteCond %{REMOTE_ADDR} !^(165\.193\.12[23]\.|10\.160\.3\.|127\.)
  RewriteRule /robots.txt /site/html/applets/drupal-robots.txt [L]

  Alias /images/ /site/images/

  RewriteRule ^/images/video/.*\.flv - [R=404,L]
  RewriteRule ^(.*)\.[0-9]{10}\.(css|js|gif|png|jpe?g)$ $1.$2

  RewriteRule ^(/dyn/.*)$ /site/images/$1 [L]
  RewriteRule ^/img/(.*)$ /site/images/fe/$1 [L]
  RewriteRule ^/mov/(.*)$ /site/images/mov/$1 [L]
  RewriteRule ^/images/(ip[esk]?a/)?([^/.])([^/.])([^/.])([^/.])([^/.])([^/]+)$ /site/images/$2/$3/$4/$5/$6/$2$3$4$5$6$7 [L]
  RewriteRule ^/images/(ip[esk]?a/)?([^/.])([^/.])([^/.])([^/.])(\.[^/]+)$ /site/images/$2/$3/$4/$5/$2$3$4$5$6 [L]
  RewriteRule ^/images/(ip[esk]?a/)?([^/.])([^/.])([^/.])(\.[^/]+)$ /site/images/$2/$3/$4/$2$3$4$5 [L]
  RewriteRule ^/images/(ip[esk]?a/)?([^/.])([^/.])(\.[^/]+)$ /site/images/$2/$3/$2$3$4 [L]
  RewriteRule ^/images/([^/]+/.*)$ /site/images/$1 [L]
  RewriteRule ^/js/(.*)$ /site/html/js/$1 [L]

  RewriteRule ^/ln/[^/.]+/images/shim.gif$ /site/images/s/p/a/c/e/spacer.gif [L]

  AddType image/vnd.microsoft.icon .ico

  ErrorDocument 200 "OK"
  RewriteRule ^/googlee4ee029fb4377552.html$ - [R=200,L]
  RewriteRule ^/google32115ef79866f150.html$ - [R=200,L]

  php_value magic_quotes_gpc                0
  php_value register_globals                0
  php_value session.auto_start              0
  php_value auto_prepend_file               /site/cfg/prepend.php

  # Reduce the time dynamically generated pages are cache-able.
  <IfModule mod_expires.c>
    ExpiresByType text/html A1
  </IfModule>
</VirtualHost>
  