<VirtualHost *:<%= @params[:server_port] || node['apache']['listen_ports'].first %>>
  ServerName <%= @params[:server_name] %>
  <% if @params[:server_aliases] -%>
  ServerAlias <%= @params[:server_aliases].join " " %>
  <% end -%>
  DocumentRoot <%= @params[:docroot] %>
  
  <Directory <%= @params[:docroot] %>>
    Options Indexes FollowSymLinks
    AllowOverride All
    Require all granted
  </Directory>

  <IfModule mod_rewrite.c>
    RewriteEngine on
  <% if node['apache']['version'] == '2.2' -%>
    RewriteRule ^/server-status - [L]
  <% elsif node['apache']['version'] == '2.4' -%>
    RewriteCond %{REQUEST_URI} /server-status
    RewriteRule ^ - [END]
  <% end -%>
  </IfModule>

  LogFormat "%h %{local}p %u %t \"%r\" %>s %B \"%{Referer}i\" \"%{User-Agent}i\" %{Host}i %v %D %{Apache}C \"%{Accept-Language}i\" \"%{X-Forwarded-For}i\" %{X-Amz-Cf-Id}i" combined
  CustomLog "|/usr/bin/rotatelogs -l /var/log/apache2/<%= @params[:server_name] %>.%Y%m%d 86400" common
  
</VirtualHost>
