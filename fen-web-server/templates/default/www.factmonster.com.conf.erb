<VirtualHost *:80>
  ServerName <%= @params[:server_name] %>
  <% if @params[:server_aliases] -%>ServerAlias <%= @params[:server_aliases].join " " %><% end -%>
  UseCanonicalName on

  DocumentRoot <%= @params[:docroot] %>

  <Directory <%= @params[:docroot] %>>
    Require all granted
  </Directory>

  AddType application/x-httpd-php .php .php3 .xhtml .phtml .html .rss
  php_value auto_prepend_file "/site/cfg/prepend-refsites.php"
  php_value default_charset "utf-8"

  LogFormat "%h %{local}p %u %t \"%r\" %>s %B \"%{Referer}i\" \"%{User-Agent}i\" %{Host}i %v %D %{Apache}C \"%{Accept-Language}i\" \"%{X-Forwarded-For}i\" %{X-Amz-Cf-Id}i" combined
  CustomLog "|/usr/bin/rotatelogs -l <%= node['apache']['log_dir'] %>/factmonster.com.%Y%m%d 86400" combined

  RewriteEngine on

  RewriteRule ^/arrowpoint.html$ - [R=410,L]
  RewriteRule ^/think-subscription/.* - [R=410,L]
  RewriteRule ^/(css|images|img|js)/(.*) http://i.infopls.com/$1/$2 [R=301,L]

  SetEnvIfNoCase Host "factmonster\.com$" VARIANT=www
  SetEnvIfNoCase Host "factmonster\.info$" VARIANT=nopop
  SetEnvIfNoCase Host "rss.factmonster.com$" TEMPLATE_DIR=isynd.infoplease.com
  SetEnvIfNoCase Host "zip\.infoplease\.com$" VARIANT=zip
  SetEnvIfNoCase Host "^zip\." TEMPLATE_DIR=zip.factmonster.com

  RewriteRule .? - [E=TLD:factmonster.com]
  RewriteCond %{HTTP_HOST} ^(zip|dev|cert|vli[0-9][0-9]|d[0-9]|sterno|enthalpy)\.
  RewriteRule .? - [E=SERVER:%1.]

  Alias /tmpl/ <%= @params[:docroot] %>/template/www.factmonster.com/

  RewriteMap old_ce dbm=SDBM:<%= @params[:docroot] %>/encyclopedia/map/ip_ce_frurl.map
  RewriteRule ^/ce6/(.*)/A0(.*).html  http://%{HTTP_HOST}${old_ce:$2} [R=301,L]


# [3] >>>>>> ../../global/sitemaps.conf
# XML Site map is in /thesaurus.infoplease.com/
RewriteCond %{ENV:VARIANT} ^(thesaurus)$
RewriteRule ^/(sitemap[0-9a-z]?\.xml)$ /sitemaps/%1.%{ENV:TLD}/$1 [L]

# Sitemap rewrite rule
RewriteRule ^/(sitemap[0-9]*\.xml)$ <%= @params[:docroot] %>/sitemaps/%{SERVER_NAME}/$1 [L]
# [3] <<<<<< ../../global/sitemaps.conf


# [3] >>>>>> ../../global/dictionary-redirects.conf
# Dictionary word lookup by path
RewriteRule ^/(dictionary|word)/([^/]+)(.html)$ http://%{ENV:SERVER}dictionary.%{ENV:TLD}/$2 [R=301,L]
RewriteRule ^/(dictionary|word)/([^/]+)$ http://%{ENV:SERVER}dictionary.%{ENV:TLD}/$2 [R=301,L]

RewriteRule ^/(definitions-[a-z].html)$ http://%{ENV:SERVER}dictionary.%{ENV:TLD}/$1 [R=301,L]
RewriteRule ^/(definitions-[a-z][a-z][a-z].html)$ http://%{ENV:SERVER}dictionary.%{ENV:TLD}/$1 [R=301,L]
RewriteRule ^/definitions-([a-z]+).html$ http://%{ENV:SERVER}dictionary.%{ENV:TLD}/$1 [R=301,L]

# Dictionary word lookup by query string
RewriteCond %{REQUEST_URI} ^/(dictionary|word)/?$
RewriteCond %{QUERY_STRING} (q|word|query)=([^&]+)
RewriteRule ^(.*) http://%{ENV:SERVER}dictionary.%{ENV:TLD}/%2? [R=301,L]

# Thesaurus word lookup by path
RewriteRule ^/(synonyms?|thesaurus)/([^/]+)(.html)$ http://%{ENV:SERVER}thesaurus.%{ENV:TLD}/$2 [R=301,L]
RewriteRule ^/(synonyms?|thesaurus)/([^/]+)$ http://%{ENV:SERVER}thesaurus.%{ENV:TLD}/$2 [R=301,L]

# Thesaurus word lookup by query string
RewriteCond %{REQUEST_URI} ^/(synonyms?|thesaurus)/?$
RewriteCond %{QUERY_STRING} (q|word|query)=([^&]+)
RewriteRule ^(.*) http://%{ENV:SERVER}thesaurus.%{ENV:TLD}/%2? [R=301,L]

# Dictionary and Thesaurus index pages
RewriteRule ^/(dictionary|thesaurus)(/|.html)?$ http://%{ENV:SERVER}$1.%{ENV:TLD}/ [R=301,L]
# [3] <<<<<< ../../global/dictionary-redirects.conf


# [3] >>>>>> ../../global/fmredirects.conf
  LogFormat "%h %{local}p %u %t \"%r\" %>s %B \"%{Referer}i\" \"%{User-Agent}i\" %{Host}i %v %D %{Apache}C \"%{Accept-Language}i\" \"%{X-Forwarded-For}i\" %{X-Amz-Cf-Id}i" combined
  CustomLog "|/usr/bin/rotatelogs -l <%= node['apache']['log_dir'] %>/factmonster.com.%Y%m%d 86400" common

  RewriteEngine on
  RewriteOptions inherit

  RewriteRule ^.+/favicon.ico$ http://i.factmonster.com/images/icons/fm_favicon.ico [R=301,L]
  AliasMatch  ^/favicon.ico$ /site/images/icons/fm_favicon.ico

  AliasMatch ^/(apple-touch-icon[^.]*[.]png)$ /site/images/factmonster/$1

  RewriteCond %{REQUEST_URI} ^/css/([a-zA-Z]+)\.css$
  RewriteCond <%= @params[:docroot] %>l/css/fm/%1.css -f
  RewriteRule ^/css/([a-zA-Z]+)\.css$ <%= @params[:docroot] %>/css/fm/$1.css [L]

  RewriteRule ^/search(\.php3)? /ksearch.php3 [PT]
  RewriteRule ^/(yearbyyear.html) <%= @params[:docroot] %>/main/$1 [L]

  AliasMatch  ^/([^/]*)\.rdf$ <%= @params[:docroot] %>/kids/$1.rdf



# [4] >>>>>>>> ../../global/refsites.conf

# [5] >>>>>>>>>> ../../global/webmaster.conf
  ErrorDocument 200 "OK"
  RewriteRule ^/google176b05c160c64c56.html$ - [R=200,L]
  RewriteRule ^/google32115ef79866f150.html$ - [R=200,L]
  RewriteRule ^/googlee4ee029fb4377552.html$ - [R=200,L]
# [5] <<<<<<<<<< ../../global/webmaster.conf


# [5] >>>>>>>>>> ../../global/movies.conf
RewriteRule ^/(movies)(.html)?$ http://%{HTTP_HOST}/$1/ [R=301,L]
RewriteRule ^/(movies)/(index.html)$ http://%{HTTP_HOST}/$1/ [R=301,L]
RewriteRule ^/(movies)/$ /applets/$1.php [L]
RewriteRule ^/(movies)/(.*)/([0-9]{2,7})$ /applets/$1.php?id=$3 [L]
RewriteRule ^/(movies)/([0-9]{2,7})$ /applets/$1.php?id=$2 [L]
RewriteRule ^/(movies)/([^/]+)$ /applets/$1.php?fl=$2 [L]

RewriteCond  %{HTTP_HOST}  familyeducation.com
RewriteCond  %{HTTP_HOST}  !school.familyeducation.com
RewriteRule ^(/edu/colleges/.*) / [R=301,L]

RewriteRule ^/edu/colleges/([A-Za-z][A-Za-z])(/|\.html)?$ / [R=301,L]
RewriteRule ^/edu/colleges/([0-9]+)(/|\.html)?$ / [R=301,L]
RewriteRule ^/edu/colleges/([0-9]+)/([a-zA-Z]+)\.html / [R=301,L]
# [5] <<<<<<<<<< ../../global/movies.conf


# [5] >>>>>>>>>> ../../global/richmedia.conf
RewriteRule ^/PointRollAds.htm$ /ads/pointrollads.htm [L]
# [5] <<<<<<<<<< ../../global/richmedia.conf


  php_value auto_prepend_file "/site/cfg/prepend-ip.php"
  php_value default_charset "utf-8"

  RewriteMap asc int:unescape

  RewriteCond %{THE_REQUEST} ^[A-Z]{3,9}\ (/[^?]*)(\?[^\ ]*)?\ HTTP/
  RewriteRule .? - [E=qRed:no,E=myURI:%1,E=myQS:%2]

  RewriteCond %{ENV:myURI} %2[Ff]
  RewriteRule .* - [E=qRed:yes,E=myURI:${asc:%{ENV:myURI}}]

  RewriteCond %{ENV:myURI} ^.*/http:/+[^/]+(/.*)$
  RewriteRule .* - [E=qRed:yes,E=myURI:%1]

  # Remove trailing punctutation
  RewriteCond %{ENV:myURI} ^(.*)_+$
  RewriteRule . - [E=qRed:yes,E=myURI:%1]

  # Remove multiple contiguous slashes in URL (up to three instances)
  RewriteCond %{ENV:myURI} ^(.*)//+(.*)$
  RewriteRule . - [E=qRed:yes,E=myURI:%1/%2,C]
  RewriteCond %{ENV:myURI} ^(.*)//+(.*)$
  RewriteRule . - [E=myURI:%1/%2,C]
  RewriteCond %{ENV:myURI} ^(.*)//+(.*)$
  RewriteRule . - [E=myURI:%1/%2]

  # Redirect direct client requests for "<anything>/index.html" to "<anything>/"
  RewriteCond %{ENV:myURI} ^(/([^/]+/)*)index\.html [NC]
  RewriteRule . - [E=qRed:yes,E=myURI:%1]

  RewriteCond %{ENV:qRed} ^yes$
  RewriteRule .* http://%{HTTP_HOST}%{ENV:myURI}%{ENV:myQS} [R=301,L]

  RedirectMatch permanent ^(.*)//(.*) $1/$2

  RewriteRule //'swf_url//'$ <%= @params[:docroot] %>/main/arrowpoint.html [G,L]

  RewriteRule ^/us/census/data/([^/]+)/(index.html)?$ /us/census/data/driver.php?file=$1/default.html [L]
  RewriteRule ^/us/census/data/([^/]+/[^/]+?-county)/(index.html)?$ /us/census/data/driver.php?file=$1/default/default.html [L]
  RewriteRule ^/us/census/data/([^/]+/[^/]+)/(index.html)?$ /us/census/data/driver.php?file=$1/default.html [L]

  RewriteRule ^/us/census/data/(.+\.html) /us/census/data/driver.php?file=$1 [L]
  RewriteRule ^/us/census/maps/(.+\.html) /us/census/maps/driver.php?file=$1 [L]
  RewriteRule ^/biography/us/congress/(.+\.html) /biography/us/congress/driver.php?file=$1 [L]

  RewriteRule ^(/computers/jargon/I)-frame.html http://%{HTTP_HOST}$1.html [R=301,L]

  RedirectMatch permanent ^/redir.php3/dyk(/.*)$ $1
  RedirectMatch permanent ^/fr/[^/]+(/.*)$ $1

  RewriteRule ^/(almanacs|world|us|people|sports|states|countries|history|ent|bus|society|sci)/?$ /main/$1.html [L]

  # send ditcionary IDs to id.php3
  RewriteRule ^/(ipd)/([^/]+)$ /applets/ip.php3 [L]

  # bare years get redirected
  RewriteRule ^(/year/[0-9]{4})$ http://%{HTTP_HOST}$1.html [R=301,L]

  # our who2 urls do not have dashes
  RewriteRule ^(/biography/var/)([a-z]+)-(.+) $1/$2$3 [PT]
  RewriteRule ^(/biography/var/)([a-z]+)-(.+) $1/$2$3 [PT]
  RewriteRule ^(/biography/var/)([a-z]+)-(.+) $1/$2$3 [PT]

  # and bare names get a .html suffix
  RewriteRule ^(/biography/var/[a-z]+)$ http://%{HTTP_HOST}$1.html [R=301,L]

  RewriteRule ^/(action-newemail.php|emailpage.php)$ <%= @params[:docroot] %>/applets/$1 [L]

  # On dictionary and thesaurus, redirect static files to edge cache
  # (rules for these variants are complex)
  # (this redirect breaks CSS testing on DEV because you're looking at the edge cache)
  # TODO: fix CSS on DEV
  RewriteCond %{ENV:VARIANT} ^(dictionary|thesaurus)$
  RewriteRule ^/(images|img|css|js)/.* http://i.%{ENV:TLD}/%{REQUEST_URI} [R=301,L]

  # These work around issues in GAM and adsense where host domain is not reliably set
  # http://www.webmasterworld.com/google_adsense/3911078.htm
  # http://www.google.com/support/forum/p/AdSense/thread?tid=58458521e9999377&hl=en
  RewriteRule ^.*/ga.js http://www.google-analytics.com/ga.js  [R=301,L]
  RewriteRule ^/(gampad|pagead)/(.*\.js)$ http://partner.googleadservices.com/$1/$2 [R=301,L]
  RewriteRule ^/(google_ads\.js|google_ads_dbg\.js)$ http://partner.googleadservices.com/$1 [R=301,L]

  # Same for rubicon project broken link
  RewriteRule /pixel.rubiconproject.com/tap.php$ http://pixel.rubiconproject.com/tap.php [R=301,L]

  RewriteRule ^/(crossword.html|xword/?)$ /applets/xword.php [L]

  RewriteRule ^/(analogies|birthday|dayinhistory|onthisday|quoteoftheday|schoolword|spellcheck|spellingbee|topten|weatherfacts|wordoftheday)/?$ /applets/$1.php [L]
  RewriteRule ^/(birthday|dayinhistory)/([a-zA-Z]+)-([0-9]+)$ /applets/$1.php?month=$2&day=$3 [QSA,L]
  RewriteRule ^/(analogies|schoolword|spellingbee|wordoftheday)/([a-zA-Z]+)-([0-9]+)$ /applets/$1.php?month=$2&day=$3 [QSA,L]

  RewriteRule ^/daily/?$                  /main/daily.html [L]

  RewriteRule ^/yearbyyear$               http://%{HTTP_HOST}/yearbyyear.html [R=301,L]
  RewriteRule ^/year/?$                   http://%{HTTP_HOST}/yearbyyear.html [R=301,L]
  RewriteRule ^/ipd/?$                    http://%{HTTP_HOST}/dictionary.html [R=301,L]
  RewriteRule ^/ce[56]/?$                 http://%{HTTP_HOST}/encyclopedia/ [R=301,L]
  RewriteRule ^/(askeds|atlas|encyclopedia|homework|quizzes|xwords)$  http://%{HTTP_HOST}/$1/ [R=301,L]
  RewriteRule ^/encyclopedia/(social-sciences-law|sports-everyday-life)/$ http://%{HTTP_HOST}/encyclopedia/$1.html [R=301,L]
  RewriteRule ^/encyclopedia/(earth-environment|literature-arts|philosophy-religion|plants-animals|science-technology)/$ http://%{HTTP_HOST}/encyclopedia/$1.html [R=301,L]
  RewriteRule ^/encyclopedia/(history|medicine|people|places)/$ http://%{HTTP_HOST}/encyclopedia/$1.html [R=301,L]
  RewriteRule ^/encyclopedia/science/$ http://%{HTTP_HOST}/encyclopedia/science-technology.html [R=301,L]
  RewriteRule ^/encyclopedia/entertainment/$ http://%{HTTP_HOST}/encyclopedia/literature-arts.html [R=301,L]
  RewriteRule ^/encyclopedia/world/$ http://%{HTTP_HOST}/encyclopedia/places.html [R=301,L]
  RewriteRule ^/encyclopedia/([a-z]+)\+([a-z]+)$ http://%{HTTP_HOST}/encyclopedia/$1-$2.html [R=301,L]

  RewriteRule ^/world/events/(201[0-9])/(index.html)?$ http://%{HTTP_HOST}/news/$1/current-events/ [R=301,L]
  RewriteRule ^/world/events/(201[0-9])/(world_[a-z][a-z][a-z][a-z]?.html)?$ http://%{HTTP_HOST}/news/$1/current-events/$2 [R=301,L]
  RewriteRule ^/world/events/(201[0-9])/world_([a-z]+-[a-z]+).html?$ http://%{HTTP_HOST}/news/$1/current-events/$2_jan.html [R=301,L]
  RewriteRule ^/world/disasters/(201[0-9]).html?$ http://%{HTTP_HOST}/news/$1/current-events/science-disasters_jan.html [R=301,L]
  RewriteRule ^/(news/year-in-review/201[0-9]).html?$ http://%{HTTP_HOST}/$1/ [R=301,L]
  RewriteRule ^/(news)/(201[0-9])/\2/(current-events)/(index.html)?$ http://%{HTTP_HOST}/$1/$2/$3/ [R=301,L]

  RewriteCond %{REQUEST_URI} !\.
  RewriteCond <%= @params[:docroot] %>%{REQUEST_URI} -d
  RewriteCond <%= @params[:docroot] %>%{REQUEST_URI}/index.html !\.(php3?|[xp]?html?|css|gif|jpe?g)$
  RewriteRule (%{REQUEST_URI}) http://%{HTTP_HOST}$1/ [R=301,L]


# [5] >>>>>>>>>> ../../global/refsite-polls.conf
RewriteRule /([^/]+/)?poll/([^/]+)/results /applets/pollresults.php?poll=$2 [L,QSA]
RewriteRule /([^/]+/)?poll/([^/]+) /applets/launchpoll.php3?poll=$2 [L,QSA]
# [5] <<<<<<<<<< ../../global/refsite-polls.conf


  RewriteRule ^/pollresults$ /applets/pollresults.php?poll=$1 [L,QSA]

  ### All bare-word top-level URLs must precede this rule
  RewriteRule ^/([A-Za-z0-9]+)$           /applets/id.php3?$1 [L]

  RewriteRule ^(.*)-p([0-9]+).html$ $1.html?page=$2 [QSA]

  ###
  ### Rewrites for subdirectories
  ###

  ### Old 'bio' directory replaced by birthday script:
  RewriteRule ^/bio/([0-9]+)-([0-9]+) http://%{HTTP_HOST}/birthday?date=$1-$2-2005 [R=301,L]

  ### ce5 pages redirected to ID script, which points them to ce6
  RewriteRule ^/ce5/([0-9a-zA-Z]+).s?html /applets/id.php3?$1 [L]

  RewriteRule ^/id /cgi-bin/id [PT,S=1]
  RewriteRule ^/cgi-bin.id /cgi-bin/id [PT]
  RewriteRule ^/cgi-bin/id/(ce5|ip[eks]?a)/(.*) /applets/id.php3?$2 [L]
  RewriteRule ^/cgi-bin/id/(.*) /applets/id.php3?$1 [L]
  Alias /cgi-bin/id <%= @params[:docroot] %>/applets/id.php3

  RewriteRule ^/ce6/ent/$ http://%{HTTP_HOST}/encyclopedia/literature-arts.html [R=301,L]
  RewriteRule ^/ce6/bus/$ http://%{HTTP_HOST}/encyclopedia/0sslecon.html [R=301,L]
  RewriteRule ^/ce6/sci/$ http://%{HTTP_HOST}/encyclopedia/science-technology.html [R=301,L]
  RewriteRule ^/ce6/sports/$ http://%{HTTP_HOST}/encyclopedia/0slsport.html [R=301,L]
  RewriteRule ^/ce6/world/$ http://%{HTTP_HOST}/encyclopedia/places.html [R=301,L]
  RewriteRule ^/ce6/(history|people)/$ http://%{HTTP_HOST}/encyclopedia/$1.html [R=301,L]
  RewriteRule ^/ce6/(society|us)/$ http://%{HTTP_HOST}/$1.html [R=301,L]

  RewriteRule ^/ce6/([^/.]+)$ /applets/id.php3?ce6=$1 [L]
  RewriteCond %{REQUEST_URI} ^/encyclopedia/[a-zA-Z0-9]
  RewriteCond %{REQUEST_URI} !\.(php3?|[xp]?html?|css|gif|jpe?g)$
  RewriteRule ^/encyclopedia/([^/]+)$ /applets/id.php3?ce6=$1 [L]

  RewriteRule ^/t/([^/]+)/([^/]+)\.html$ http://%{HTTP_HOST}/t/$1/$2/ [R=301,L]

  RewriteRule ^/cgi-bin/schoolword/ /applets/schoolword.php [L]

  RewriteRule ^/cgi-bin/(birthday|daily|dayinhistory|topten|xword) http://%{HTTP_HOST}/$1 [R=301,L]
  RewriteRule ^/cgi-bin/analogy http://%{HTTP_HOST}/analogies [R=301,L]
  RewriteRule ^/cgi-bin/topten http://%{HTTP_HOST}/topten [R=301,L]
  RewriteRule ^/cgi-bin/weather http://%{HTTP_HOST}/weatherfacts [R=301,L]
  RewriteRule ^/cgi-bin/xword http://%{HTTP_HOST}/xword [R=301,L]

  RewriteRule ^/cgi-bin/word/? http://%{HTTP_HOST}/wordoftheday [R=301,L]
  RewriteRule ^/cgi-bin/analogy/$ http://%{HTTP_HOST}/analogies [R=301,L]
  RewriteRule ^/cgi-bin/weather/$ http://%{HTTP_HOST}/weatherfacts [R=301,L]
  RewriteRule ^/cgi-bin/xword/$ http://%{HTTP_HOST}/xwords/ [R=301,L]
  RewriteRule ^/cgi-bin/askeds/$ /askeds/current.html [L]
  RewriteRule ^/askeds$ /askeds/current.html [L]

  RewriteRule ^/atlas/state/$ http://%{HTTP_HOST}/atlas/unitedstates.html [R=301,L]
  RewriteRule ^/atlas/country/$ http://%{HTTP_HOST}/countries/ [R=301,L]

  RewriteRule ^/app/([^/]+)/([^/.]+)\.(xml|btn)$ <%= @params[:docroot] %>/app/$1/%{SERVER_NAME}/$2.$3 [L]

  Alias /cgi-bin/cisearch     <%= @params[:docroot] %>/applets/search.php3
  Alias /cgi-bin/isearch      <%= @params[:docroot] %>/applets/search.php3
  Alias /cgi-bin/schoolword   <%= @params[:docroot] %>/applets/schoolword.php
  Alias /cgi-bin/spot	        <%= @params[:docroot] %>/applets/spotlight.php3
  Alias /cgi-bin/units        <%= @params[:docroot] %>/applets/units.php3
  Alias /cgi-bin/emailbutton  <%= @params[:docroot] %>/applets/emailpage.php
  Alias /cgi-bin/spelling     <%= @params[:docroot] %>/applets/spelling.php

  Alias /cgi-bin/askeds	<%= @params[:docroot] %>/askeds/current.html
  Alias /cgi-bin/daily	<%= @params[:docroot] %>/main/daily.html
  Alias /daily/current.html	<%= @params[:docroot] %>/main/daily.html

  ScriptAlias /cgi-bin/searchguts /site/cgi-bin/lsearchguts

  Alias /cgi-bin/isearch.src.hqx  <%= @params[:docroot] %>/sherlock/isearch.src.hqx

  RewriteRule ^/spot/quiz-index\.html   http://%{HTTP_HOST}/quizzes/ [R=301,L]
  RewriteRule ^/(spot/quiz-|quizzes/)(accidents|backtosch|candy|dinosaur|explorers|geohistory|internet|pokemon|spelling|spies|superbowl|toys|wimbledon|xsports)1\.html$ http://%{HTTP_HOST}/quizzes/$2/1.html [R=301,L]
  RewriteRule ^/spot/quiz-(.*)\.html  http://%{HTTP_HOST}/quizzes/$1/1.html [R=301,L]
  RewriteRule ^/spot/quiz/(.*)/([0-9]+)\.html  http://%{HTTP_HOST}/quizzes/$1/$2.html [R=301,L]
  RewriteRule ^/spot/quiz-(.*)\.php3  http://%{HTTP_HOST}/quizzes/$1/1.html [R=301,L]
  RewriteRule ^/quizzes/(.*)/$ http://%{HTTP_HOST}/quizzes/$1/1.html [R=301,L]
  RewriteRule ^/spot/quiz(/)?$          http://%{HTTP_HOST}/quizzes/ [R=301,L]
  RewriteRule ^/spot/quiz/(index.html)? http://%{HTTP_HOST}/quizzes/ [R=301,L]

  #RewriteRule ^(/.+/polls/)index.(s?html?|p?html?|php3?|asp|jsp)$ $1 [R=301,L]
  #RewriteRule ^/(.+/polls/)$ /$1/index.html [L]
  RewriteRule ^/(.+)/polls/([^/]+).html /applets/launchpoll.php3?poll=$2 [L]

  RewriteRule ^/(.+)/quizzes/([^/]+)/$ http://%{HTTP_HOST}/$1/quizzes/$2/1.html [R=301,L]
  RewriteRule ^/(.+)/quizzes/([^/]+)/([0-9]+)\.html /$1/quizzes/$2.php [L]

  RewriteRule ^/internet\.html$ /ipa/A0006019.html [R]
  RewriteRule ^/videogam\.html$ /ipea/A0151958.html [R]

  RewriteRule ^/homework/answers/([0-9]+)\.html /homework/answer.php3?oid=$1 [PT]

  RewriteRule ^/astrology/(aries|aries|taurus|gemini|cancer|leo|virgo|libra|scorpio|sagittarius|capricorn|aquarius|pisces).html /astrology/index.html   [PT]
  RewriteRule ^/astrology/template.php3 /astrology/index.html   [PT]

  RewriteRule ^/ipk?a/A0921337 http://%{HTTP_HOST}/year/calendar-2005.html [R=301,L]
  RewriteRule ^/ipk?a/A0901046 http://%{HTTP_HOST}/year/calendar-2006.html [R=301,L]
  RewriteRule ^/ipk?a/A0907901 http://%{HTTP_HOST}/year/calendar-2007.html [R=301,L]

  ### New rules for .phtml pages:
  RewriteRule ^/(.*)\.phtml http://%{HTTP_HOST}/$1.html [R=301,L]

  RewriteRule ^/ce6/([a-z]+)/A([0-9][0-9][0-9][0-9])([0-9])([0-9])([0-9]).html /ce6/$1/$2/$3/$4/A$2$3$4$5.html [NC]
  RewriteRule ^/(spot)/([^.]*)(\.htm?)$ http://%{HTTP_HOST}/$1/$2.html [R=301,L]
  RewriteRule ^/(countries|states)/\.htm$ http://%{HTTP_HOST}/$1.html [R=301,L]

  RewriteRule ^/homework/answers\.html /homework/ansall.php3 [PT]
  RewriteRule ^/homework/answers/([0-9]+)\.s?html /homework/answer.php3?oid=$1 [PT]

  RewriteRule ^/rhc/[Aa]([0-9])([0-9])([0-9])([0-9])([0-9])([0-9])([0-9a-zA-Z]+).s?html /applets/id.php3?A$1$2$3$4$5$6$7 [L]

  RewriteRule ^/actioneer/ /applets/redir.php3/actioneer/
  RewriteRule ^/news/(.*)\.html /news/$1.html [PT]

  RewriteRule /world/leaders/holy-see-\(vatican-city\).html /world/leaders/holy-see-vatican-city.html [PT]

  AliasMatch  ^/([^/]*)\.php3$ <%= @params[:docroot] %>/applets/$1.php3
  AliasMatch  ^/([^/]*)\.php$  <%= @params[:docroot] %>/applets/$1.php

  RewriteRule /robots.txt <%= @params[:docroot] %>/applets/robots.php [L]
  Alias /1x1.gif <%= @params[:docroot] %>/applets/pixel.php
# [4] <<<<<<<< ../../global/refsites.conf


  RewriteRule ^/quizzes/(.*)/([0-9]+)\.html /quizzes.kids/$1.php [L]

  RewriteRule ^/(spot|quizzes)/(.*) /$1.kids/$2 [PT]
  RewriteRule ^/(mediakit)/(.*) /kids/$1/$2 [PT]

  RewriteRule ^/weather.html           http://%{HTTP_HOST}/ipka/A0772916.html [R=301,L]
  RewriteRule ^/ent.html               http://%{HTTP_HOST}/ipka/A0775745.html [R=301,L]
  RewriteRule ^/entertainmentbios.html http://%{HTTP_HOST}/ipka/A0855197.html [R=301,L]
  RewriteRule ^/history.html           http://%{HTTP_HOST}/ipka/A0001196.html [R=301,L]
  RewriteRule ^/finance.html           http://%{HTTP_HOST}/ipka/A0801192.html [R=301,L]
  RewriteRule ^/health.html            http://%{HTTP_HOST}/ipka/A0768612.html [R=301,L]
  RewriteRule ^/society.html           http://%{HTTP_HOST}/life.html [R=301,L]

  RewriteRule  ^/(ipka)/A([0-9])([0-9])([0-9])([0-9])([0-9])([0-9])([0-9A-Z]+)\.html  /$1/$2/$3/$4/$5/$6/$7/A$2$3$4$5$6$7$8.html [L,NC]

  RewriteCond %{REQUEST_URI} ^/(ip[es]?a)/A([0-9])([0-9])([0-9])([0-9])([0-9])([0-9])([0-9A-Za-z]+\.html)$
  RewriteCond <%= @params[:docroot] %>/ipka/%2/%3/%4/%5/%6/%7/A%2%3%4%5%6%7%8 -f
  RewriteRule ^/(ip[es]?a)/(A[0-9][0-9][0-9][0-9][0-9][0-9][0-9A-Z]+\.html) http://%{HTTP_HOST}/ipka/$2 [R=301,L]
  RewriteRule ^/(ip[es]?a)/(A[0-9][0-9][0-9][0-9][0-9][0-9][0-9A-Z]+\.html) /altsite/$1/$2

  RewriteRule ^/(cgi-bin/)?daily  /altsite/daily
# [3] <<<<<< ../../global/fmredirects.conf


# [3] >>>>>> ../../global/kids.conf
  AliasMatch  /favicon.ico$ /site/images/icons/fm_favicon.ico

  RewriteRule ^/ipka/?$ /kids/almanacs.html [L]
  RewriteRule ^/(almanacs|encyclopedia|world|us|people|science|sports|states|countries|games|life|mathmoney)/?$ /kids/$1.html [L]
  RewriteRule ^/sci\.html /kids/science.html [R,L]
  RewriteRule ^/([^/]*)\.(xml|html) /kids/$1.$2 [L]
  RewriteRule ^/search(\.php3)?   /applets/ksearch.php3 [L]
  RewriteRule ^/spot/(.*)\.html /spot.kids/$1.html [PT]
# [3] <<<<<< ../../global/kids.conf


  RewriteRule ^/books/rangers-apprentice/(.*) http://rangers-apprentice.factmonster.com/$1 [R=301,L]

  RewriteCond %{HTTP_HOST} "factmonster\.com$"
  RewriteRule ^/altsite/(.*) http://www.infoplease.com/$1 [R=301,L]
  RewriteRule ^/altsite/(.*) http://infoplease.info/$1 [R=301,L]
  RewriteCond %{REQUEST_URI} ^/css/([a-zA-Z]+)\.css$
  RewriteCond <%= @params[:docroot] %>/css/fm/%1.css -f
  RewriteRule ^/css/([a-zA-Z]+)\.css$ /css/fm/%1.css [PT]
</VirtualHost>

<VirtualHost 165.193.123.156:80 10.160.3.169:80 127.0.0.1:80>
  ServerName  dictionary.factmonster.com
  ServerAlias dev.dictionary.factmonster.com zip.dictionary.factmonster.com d2.dictionary.factmonster.com

  php_value auto_prepend_file "/site/cfg/prepend-ip.php"

  RewriteEngine On

  RewriteRule .? - [E=TLD:factmonster.com]
  RewriteCond %{HTTP_HOST} ^(zip|dev|cert|vli[0-9][0-9]|d[0-9]|sterno|enthalpy)\.
  RewriteRule .? - [E=SERVER:%1.]

  SetEnvIfNoCase Host "(dictionary)\.(factmonster.com)$" VARIANT=$1 TLD=$2 TEMPLATE_DIR=www.$2
  SetEnvIfNoCase Host "^([^.]*\.)%{VARIANT}\.factmonster.com$" SERVER=$1
  SetEnvIfNoCase Host "^zip\." TEMPLATE_DIR=zip.factmonster.com

RewriteRule ^/(index\.html?)?$ /kids/dictionary.html [L]
RewriteRule ^/favicon.ico /site/images/icons/fm_favicon.ico [L]

RewriteRule ^/(ak|a\.k\.|anilingus|arses?|ass|ass[-+]?backwards?|ass[-+]?holes?|ass[-+]?kick|ass[-+]?kiss|ass[-+]?kissing)$ - [R=404,L]
RewriteRule ^/(badass|balls?|ball[-+]?buster|ballocks|ballsy|bang|bare[-+]?ass|barrel[-+]?ass|bassackwards|beaver|bestiality)$ - [R=404,L]
RewriteRule ^/(bi|bisexual|bitch|bitchy|blow|blow[-+]job|bollocks(\sup)?|boob|booby|bs|buggery?|bullshit|butt|candy[-+]?ass)$ - [R=404,L]
RewriteRule ^/(chickenshit|child[-+]pornography|chink|circle[-+]jerk|clit|cock|cocksucker|cockteaser|coon|coonass|cooze|cornhole)$ - [R=404,L]
RewriteRule ^/(crack|crap|crapper|crappy|cream|cum|cunnilingus|cunt|dago|dark[-+]meat|dildo|dominatrix|dong|draggle[-+]?tail)$ - [R=404,L]
RewriteRule ^/(dumb[-+]?ass|dyke|fag|faggot|faggotry|faggy|fag[-+]hag|fart|fellatio|fingerfuck|frig|fuck|fucker|fuckheads?|fucking)$ - [R=404,L]
RewriteRule ^/(fuckoff|fuck\s*up|gangbang|gash|gays?|get|go|greaseball|greaser|half[-+]?assed|hand[-+]job|hard[-+]?ass|hard[-+]?on)$ - [R=404,L]
RewriteRule ^/(head|homos?|homosexuals?|hoo[kt]ers?|horny|horses[-+]ass|horseshit|hot[-+]shit|hump|hung|jack|jailbait|jap|jazz)$ - [R=404,L]
RewriteRule ^/(jelly[-+]roll|jerk|joint|kike|lardass|lay|lesbians?|lesbianism|lesbo|lez|lolita|masochis[mt]|mother|motherfucker)$ - [R=404,L]
RewriteRule ^/(muff|nigger|nymphet|paraphilia|pecker|pedophiliac?|pee|piss|pisse[dr]|piss[-+]?poor|pisspot|pissy|plow|poontang)$ - [R=404,L]
RewriteRule ^/(porno?|pornography|prick|pussy|quim|sadis[mt]|sambo|schlong|schtup|screw|sex[-+]toy|sexy|shit|shitfaced|shithead)$ - [R=404,L]
RewriteRule ^/(shithouse|shitkicker|shit[-+]?kicker|shitlist|shitty|sixty[-+]?nine|slut|slutty|s&?m|smart[-+]ass|smegma|snatch)$ - [R=404,L]
RewriteRule ^/(snuff[-+]film|sodomize|sodomy|son[-+]of[-+]a[-+]bitch|spic|spook|stick|suck|tight[-+]?assed|tit|tits[-+]and[-+]ass|titty|tool|ts)$ - [R=404,L]
RewriteRule ^/(turd|twat|wad|wanks?|weenie|wetback|wet[-+]dream|white[-+]meat|whores?|wise[-+]?ass|wops?)$ - [R=404,L]


# [3] >>>>>> ../../global/dictionary-rewrites.conf
#dictionary word lookup by query string
RewriteCond %{QUERY_STRING} in=(dictionary|word)
RewriteCond %{QUERY_STRING} (q|word|query)=([^&]+)
RewriteRule ^(.*) http://%{HTTP_HOST}/%2? [R=301,L]

#dictionary word lookup by query string
RewriteCond %{REQUEST_URI} ^/(dictionary|word)/?$
RewriteCond %{QUERY_STRING} (q|word|query)=([^&]+)
RewriteRule ^(.*) http://%{HTTP_HOST}/%2? [R=301,L]

RewriteRule ^/(sitemap|definitions-.+).html /dictionary/$1.html [L]
RewriteRule ^/pronkey.html /main/pronkey.html [L]
RewriteRule ^/(ads)/(.*) <%= @params[:docroot] %>/$1/$2 [L]
RewriteRule /robots.txt <%= @params[:docroot] %>/applets/robots.php [L]

#dictionary word lookup by query string
RewriteCond %{REQUEST_URI} ^/([-a-z-]+)-0([0-9])/?$
RewriteRule ^(.*) http://%{HTTP_HOST}/%1-%2 [R=301,L]

# If there is a second / send it to www
RewriteRule ^/(pages)/(.*) http://%{ENV:SERVER}www.%{ENV:TLD}/$1/$2 [R=301,L]


# [4] >>>>>>>> ../../global/sitemaps.conf
# XML Site map is in /thesaurus.infoplease.com/
RewriteCond %{ENV:VARIANT} ^(thesaurus)$
RewriteRule ^/(sitemap[0-9a-z]?\.xml)$ /sitemaps/%1.%{ENV:TLD}/$1 [L]

# Sitemap rewrite rule
RewriteRule ^/(sitemap[0-9]*\.xml)$ <%= @params[:docroot] %>/sitemaps/%{SERVER_NAME}/$1 [L]
# [4] <<<<<<<< ../../global/sitemaps.conf


# [4] >>>>>>>> ../../global/rewrite-canon.conf
  RewriteMap lc int:tolower

  # URL FIXUP REDIRECT ROUTINE
  #
  # This code uses a single external redirect to correct all detected problems.
  #
  # Get the client-requested full URI and full query string
  RewriteCond %{THE_REQUEST} ^[A-Z]{3,9}\ (/[^?]*)(\?[^\ ]*)?\ HTTP/
  RewriteRule .? - [E=myURI:%1,E=myQS:%2]

  # Convert to lowercase unless we're in an exempted directory
  RewriteCond %{ENV:myURI} !^/(applets|css|images|img|js)/
  RewriteCond %{ENV:myURI} [A-Z]
  RewriteRule .* - [E=qRed:yes,E=myURI:${lc:%{ENV:myURI}}]

  # Remove trailing punctutation
  RewriteCond %{ENV:myURI} ^(.*)[_\-]+$
  RewriteRule . - [E=qRed:yes,E=myURI:%1]

  # Remove multiple contiguous slashes in URL (up to three instances)
  RewriteCond %{ENV:myURI} ^(.*)//+(.*)$
  RewriteRule . - [E=qRed:yes,E=myURI:%1/%2,C]
  RewriteCond %{ENV:myURI} ^(.*)//+(.*)$
  RewriteRule . - [E=myURI:%1/%2,C]
  RewriteCond %{ENV:myURI} ^(.*)//+(.*)$
  RewriteRule . - [E=myURI:%1/%2]

  # Redirect direct client requests for "<anything>/index.html" to "<anything>/"
  RewriteCond %{ENV:myURI} ^(/([^/]+/)*)index\.html [NC]
  RewriteRule . - [E=qRed:yes,E=myURI:%1]
# [4] <<<<<<<< ../../global/rewrite-canon.conf


  # Replace plus signs with hyphens
  RewriteCond %{ENV:myURI} ^([^+]*)\.html?$
  RewriteRule . - [E=qRed:yes,E=myURI:%1]

  # Replace plus signs with hyphens
  RewriteCond %{ENV:myURI} ^([^+]*)[+]+(.*)$
  RewriteRule . - [E=qRed:yes,E=myURI:%1-%2]

  # Replace spaces with hyphens
  RewriteCond %{ENV:myURI} ^(.*)%20%20%20%20(.*)$ [OR]
  RewriteCond %{ENV:myURI} ^(.*)%20%20%20(.*)$ [OR]
  RewriteCond %{ENV:myURI} ^(.*)%20%20(.*)$ [OR]
  RewriteCond %{ENV:myURI} ^(.*)%20(.*)$
  RewriteRule . - [E=qRed:yes,E=myURI:%1-%2]


# [4] >>>>>>>> ../../global/rewrite-canon-doit.conf
  # Check for unsafe characters
  RewriteCond %{ENV:myURI} [^/A-Za-z0-9._~+%\-]
  RewriteRule . - [E=qRed:no,R=400]

  # Do the redirect
  RewriteCond %{ENV:qRed} ^yes$
  RewriteRule .* http://%{HTTP_HOST}%{ENV:myURI}%{ENV:myQS} [R=301,L]
  # ##### End URL fixup redirect routine #####
# [4] <<<<<<<< ../../global/rewrite-canon-doit.conf


# If it refers to a file, show it
RewriteCond <%= @params[:docroot] %>/dictionary%{REQUEST_URI}.html -f
RewriteRule ^/(.+)$ /dictionary/$1.html [L]

# Dictionary word lookup by path
RewriteRule ^/(dictionary|word)/([^/]+)(.html)$ http://%{ENV:SERVER}dictionary.%{ENV:TLD}/$2 [R=301,L]
RewriteRule ^/(dictionary|word)/([^/]+)$ http://%{ENV:SERVER}dictionary.%{ENV:TLD}/$2 [R=301,L]

# If it's not a file or common URL, look it up
RewriteCond %{REQUEST_URI} !\.(p?html|php|rss|xml|css|png|gif)$
RewriteCond %{REQUEST_URI} !^/(ads)/
RewriteRule ^/(.+)$ /applets/id.php3?word=$1 [L]

# All the rest get redirected to www
RewriteCond %{REQUEST_URI} !^/(css|img|images|js|email|action)/
RewriteCond %{REQUEST_URI} !^/(action-newemail|emailpage).php
RewriteRule ^/(.*) http://%{ENV:SERVER}www.%{ENV:TLD}/$2 [R=301,L]
# [3] <<<<<< ../../global/dictionary-rewrites.conf

</VirtualHost>

<VirtualHost 165.193.123.156:80 10.160.3.169:80 127.0.0.1:80>
  ServerName  thesaurus.factmonster.com
  ServerAlias dev.thesaurus.factmonster.com zip.thesaurus.factmonster.com d2.thesaurus.factmonster.com

  php_value auto_prepend_file "/site/cfg/prepend-ip.php"

  RewriteEngine On

  RewriteRule .? - [E=TLD:factmonster.com]
  RewriteCond %{HTTP_HOST} ^(zip|dev|cert|vli[0-9][0-9]|d[0-9]|sterno|enthalpy)\.
  RewriteRule .? - [E=SERVER:%1.]

  SetEnvIfNoCase Host "(thesaurus)\.(factmonster.com)$" VARIANT=$1 TLD=$2 TEMPLATE_DIR=www.$2
  SetEnvIfNoCase Host "^([^.]*\.)%{VARIANT}\.factmonster.com$" SERVER=$1
  SetEnvIfNoCase Host "^zip\." TEMPLATE_DIR=zip.factmonster.com

#thesaurus word lookup by query string
RewriteCond %{QUERY_STRING} in=(thesaurus|sysnonyms?)
RewriteCond %{QUERY_STRING} (q|word|query)=([^&]+)
RewriteRule ^(.*) http://%{HTTP_HOST}/%2? [R=301,L]

RewriteRule ^/(index\.html?)?$ /applets/thesaurus.php [L]
RewriteRule ^/favicon.ico /site/images/icons/fm_favicon.ico [L]

# [3] >>>>>> ../../global/thesaurus-rewrites.conf
# synonym lookup by query string
RewriteCond %{REQUEST_URI} ^/(thesaurus|synonyms?)/?$
RewriteCond %{QUERY_STRING} (q|word|query)=([^&]+)
RewriteRule ^(.*) http://%{HTTP_HOST}/%2? [R=301,L]


# [4] >>>>>>>> ../../global/sitemaps.conf
# XML Site map is in /thesaurus.infoplease.com/
RewriteCond %{ENV:VARIANT} ^(thesaurus)$
RewriteRule ^/(sitemap[0-9a-z]?\.xml)$ /sitemaps/%1.%{ENV:TLD}/$1 [L]

# Sitemap rewrite rule
RewriteRule ^/(sitemap[0-9]*\.xml)$ <%= @params[:docroot] %>/sitemaps/%{SERVER_NAME}/$1 [L]
# [4] <<<<<<<< ../../global/sitemaps.conf


RewriteRule ^/(ads)/(.*) <%= @params[:docroot] %>/$1/$2 [L]
RewriteRule /robots.txt <%= @params[:docroot] %>/applets/robots.php [L]

# Index page comes from thesaurus.html
RewriteCond %{ENV:VARIANT} ^thesaurus$
RewriteRule ^/(index.html)?$ /applets/thesaurus.php [L]

# Site map and indexes are in /thesaurus/
RewriteCond %{ENV:VARIANT} ^thesaurus$
RewriteRule ^/(sitemap|synonyms-.*)\.html$ /thesaurus/$1.html [L]

# If there is a second / send it to www
RewriteRule ^/([^/]+)/(.*) http://%{ENV:SERVER}www.%{ENV:TLD}/$1/$2 [R=301,L]


# [4] >>>>>>>> ../../global/rewrite-canon.conf
  RewriteMap lc int:tolower

  # URL FIXUP REDIRECT ROUTINE
  #
  # This code uses a single external redirect to correct all detected problems.
  #
  # Get the client-requested full URI and full query string
  RewriteCond %{THE_REQUEST} ^[A-Z]{3,9}\ (/[^?]*)(\?[^\ ]*)?\ HTTP/
  RewriteRule .? - [E=myURI:%1,E=myQS:%2]

  # Convert to lowercase unless we're in an exempted directory
  RewriteCond %{ENV:myURI} !^/(applets|css|images|img|js)/
  RewriteCond %{ENV:myURI} [A-Z]
  RewriteRule .* - [E=qRed:yes,E=myURI:${lc:%{ENV:myURI}}]

  # Remove trailing punctutation
  RewriteCond %{ENV:myURI} ^(.*)[_\-]+$
  RewriteRule . - [E=qRed:yes,E=myURI:%1]

  # Remove multiple contiguous slashes in URL (up to three instances)
  RewriteCond %{ENV:myURI} ^(.*)//+(.*)$
  RewriteRule . - [E=qRed:yes,E=myURI:%1/%2,C]
  RewriteCond %{ENV:myURI} ^(.*)//+(.*)$
  RewriteRule . - [E=myURI:%1/%2,C]
  RewriteCond %{ENV:myURI} ^(.*)//+(.*)$
  RewriteRule . - [E=myURI:%1/%2]

  # Redirect direct client requests for "<anything>/index.html" to "<anything>/"
  RewriteCond %{ENV:myURI} ^(/([^/]+/)*)index\.html [NC]
  RewriteRule . - [E=qRed:yes,E=myURI:%1]
# [4] <<<<<<<< ../../global/rewrite-canon.conf


  # Replace plus signs with hyphens
  RewriteCond %{ENV:myURI} ^([^+]*)\.html?$
  RewriteRule . - [E=qRed:yes,E=myURI:%1]

  # Replace plus signs with hyphens
  RewriteCond %{ENV:myURI} ^([^+]*)[+]+(.*)$
  RewriteRule . - [E=qRed:yes,E=myURI:%1-%2]

  # Replace spaces with hyphens
  RewriteCond %{ENV:myURI} ^(.*)%20%20%20%20(.*)$ [OR]
  RewriteCond %{ENV:myURI} ^(.*)%20%20%20(.*)$ [OR]
  RewriteCond %{ENV:myURI} ^(.*)%20%20(.*)$ [OR]
  RewriteCond %{ENV:myURI} ^(.*)%20(.*)$
  RewriteRule . - [E=qRed:yes,E=myURI:%1-%2]

  # Replace spaces with hyphens
  RewriteCond %{ENV:myURI} ^(.*)\+\+(.*)$ [OR]
  RewriteCond %{ENV:myURI} ^(.*)\+(.*)$
  RewriteRule . - [E=qRed:yes,E=myURI:%1-%2]


# [4] >>>>>>>> ../../global/rewrite-canon-doit.conf
  # Check for unsafe characters
  RewriteCond %{ENV:myURI} [^/A-Za-z0-9._~+%\-]
  RewriteRule . - [E=qRed:no,R=400]

  # Do the redirect
  RewriteCond %{ENV:qRed} ^yes$
  RewriteRule .* http://%{HTTP_HOST}%{ENV:myURI}%{ENV:myQS} [R=301,L]
  # ##### End URL fixup redirect routine #####
# [4] <<<<<<<< ../../global/rewrite-canon-doit.conf


# synonym lookup by path
RewriteRule ^/(thesaurus|synonyms?)/([^/]+)(.html)$ http://%{ENV:SERVER}thesaurus.%{ENV:TLD}/$2 [R=301,L]
RewriteRule ^/(thesaurus|synonyms?)/([^/]+)$ http://%{ENV:SERVER}thesaurus.%{ENV:TLD}/$2 [R=301,L]

# If it's not a file or common URL, look it up
RewriteCond %{REQUEST_URI} !\.(p?html|php|rss|xml|css|png|gif)$
RewriteCond %{REQUEST_URI} !^/(ads)/
RewriteRule ^/([-_.a-zA-Z0-9]+)/?$ /applets/thesaurus.php?word=$1 [L]

# All the rest get redirected to www
RewriteCond %{ENV:VARIANT} ^thesaurus$
RewriteCond %{REQUEST_URI} !^/(ads|css|img|images|js)/
RewriteRule ^/(.*) http://%{ENV:SERVER}www.%{ENV:TLD}/$2 [QSA,R=301,L]
# [3] <<<<<< ../../global/thesaurus-rewrites.conf

</VirtualHost>

<VirtualHost *:80>
  ServerName <%= @params[:domain_name] %>
  ServerAlias *.<%= @params[:domain_name] %>
  RewriteEngine On
  RewriteRule ^/(.*) http://www.<%= @params[:domain_name] %>/$1 [R=301,L]
</VirtualHost>